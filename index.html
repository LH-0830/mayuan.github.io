<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©¬å…‹æ€ä¸»ä¹‰åŸç† - æ™ºèƒ½é¢˜åº“ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* æ ¸å¿ƒé…è‰²ï¼šæ›´ç°ä»£çš„è“è‰²ç³» */
            --primary: #3b82f6; /* äº®è“ */
            --primary-dark: #2563eb;
            --primary-light: #eff6ff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            
            /* çŠ¶æ€è‰² */
            --success: #10b981;
            --success-bg: #d1fae5;
            --error: #ef4444;
            --error-bg: #fee2e2;
            
            /* å¸ƒå±€å‚æ•° */
            --sidebar-width: 260px;
            --card-radius: 16px;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body { 
            margin: 0; 
            font-family: -apple-system, "BlinkMacSystemFont", "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: var(--bg-gradient); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            color: #374151;
        }
        
        /* --- ä¾§è¾¹æ ç¾åŒ– --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            flex-direction: column;
            padding: 30px 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.02);
            z-index: 10;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar h2 { 
            padding: 0 15px; 
            font-size: 20px; 
            color: #1f2937; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-weight: 700;
        }
        .unit-btn {
            padding: 12px 16px;
            margin-bottom: 8px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        .unit-btn:hover { 
            background: #f3f4f6; 
            color: var(--primary); 
            transform: translateX(5px);
        }
        .unit-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* --- ä¸»åŒºåŸŸç¾åŒ– --- */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container {
            width: 100%;
            max-width: 850px;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 50px;
            min-height: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .header-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            color: #9ca3af; 
            font-size: 14px; 
            margin-bottom: 30px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #f3f4f6; 
        }
        #current-unit-name {
            font-weight: 600;
            color: #4b5563;
            font-size: 16px;
        }
        #progress-text {
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        /* é¢˜ç›®åŒºåŸŸ */
        #quiz-area { flex: 1; }
        
        .q-type { 
            background: var(--primary); 
            color: white;
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: bold;
            vertical-align: 2px; 
            margin-right: 8px; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .question-text { 
            font-size: 20px; 
            font-weight: 600; 
            color: #111827; 
            line-height: 1.7; 
            margin-bottom: 40px; 
        }
        
        /* é€‰é¡¹åˆ—è¡¨ */
        .options-list { list-style: none; padding: 0; margin: 0; }
        .option-item {
            padding: 18px 25px;
            margin-bottom: 15px;
            border: 2px solid #f3f4f6;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #4b5563;
            position: relative;
            overflow: hidden;
        }
        /* æ‚¬åœæ•ˆæœ */
        .option-item:hover { 
            border-color: #bfdbfe; 
            background: #fcfdfe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        /* é€‰ä¸­çŠ¶æ€ */
        .option-item.selected { 
            border-color: var(--primary); 
            background: var(--primary-light); 
            color: var(--primary-dark);
            font-weight: 600;
        }
        /* æ­£ç¡®/é”™è¯¯çŠ¶æ€ */
        .option-item.correct { 
            border-color: var(--success); 
            background: var(--success-bg); 
            color: #065f46;
        }
        .option-item.correct::after {
            content: "âœ“";
            position: absolute;
            right: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        .option-item.wrong { 
            border-color: var(--error); 
            background: var(--error-bg); 
            color: #991b1b;
        }
        .option-item.wrong::after {
            content: "âœ•";
            position: absolute;
            right: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .control-bar {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: 0.2s;
            letter-spacing: 0.5px;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:hover { 
            background: var(--primary-dark); 
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }
        .btn-outline { 
            background: white; 
            border: 2px solid #e5e7eb; 
            color: #6b7280; 
        }
        .btn-outline:hover { 
            border-color: #d1d5db; 
            background: #f9fafb;
            color: #374151;
        }

        /* é”™é¢˜å¼€å…³ */
        .toggle-mode { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 14px; 
            color: #6b7280; 
            background: #f9fafb;
            padding: 8px 16px;
            border-radius: 20px;
        }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #d1d5db; transition: .4s; border-radius: 24px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 18px; width: 18px; 
            left: 3px; bottom: 3px; background-color: white; 
            transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .result-msg { 
            margin-top: 10px; 
            font-weight: bold; 
            min-height: 24px; 
            text-align: center;
            font-size: 16px;
        }

        

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
/* === æ–°å¢ï¼šç™»å½•é¡µæ ·å¼ === */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); /* æ·±è“å•†åŠ¡é£ */
    z-index: 9999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    width: 360px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeInUp 0.5s ease;
}

.login-header h3 { margin: 0 0 10px 0; color: #1f2937; font-size: 24px; }
.login-header p { margin: 0 0 30px 0; color: #6b7280; font-size: 14px; }

.input-group { text-align: left; margin-bottom: 20px; }
.input-group label { display: block; font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 8px; }
.input-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 16px;
    outline: none;
    box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢è¾“å…¥æ¡†æ’‘ç ´å®¹å™¨ */
    transition: 0.3s;
}
.input-group input:focus { border-color: #3b82f6; background: #eff6ff; }

.login-btn {
    width: 100%;
    padding: 14px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}
.login-btn:hover { background: #2563eb; transform: translateY(-2px); }

.error-msg { color: #ef4444; font-size: 14px; min-height: 20px; margin-top: 15px; }

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* éšè—ä¸»ç•Œé¢ï¼Œé˜²æ­¢æœªç™»å½•æ—¶é€šè¿‡Tabé”®æ“ä½œ */
body.locked { overflow: hidden; }
/* === æ‰‹æœºç«¯è‡ªé€‚åº”æ ¸å¿ƒä»£ç  === */
@media (max-width: 768px) {
    .sidebar {
        position: fixed; left: 0; top: 0; bottom: 0;
        width: 75%; max-width: 300px;
        transform: translateX(-100%); /* é»˜è®¤éšè— */
    }
    .sidebar.active { transform: translateX(0); } /* æ¿€æ´»æ˜¾ç¤º */
    
    .mobile-nav-btn { display: block; } /* æ˜¾ç¤ºèœå•æŒ‰é’® */
    .main-content { padding: 15px; padding-top: 70px; }
    .container { padding: 25px 20px; }
    
    /* æŒ‰é’®å¸ƒå±€è°ƒæ•´ */
    .control-bar { justify-content: center; }
    .btn { flex: 1; min-width: 100px; }
    #action-btn { flex: 1 1 100%; order: 10; margin-top: 10px; }
}

/* é®ç½©å±‚å’ŒæŒ‰é’®æ ·å¼ */
.sidebar-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 40;
    display: none; opacity: 0; transition: opacity 0.3s;
}
.sidebar-overlay.active { display: block; opacity: 1; }

.mobile-nav-btn {
    display: none; position: fixed; top: 15px; left: 15px; z-index: 30;
    background: white; border: none; padding: 10px; border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 20px; color: #3b82f6;
}
/* === æ–°å¢ï¼šAI è§£æåŒºåŸŸæ ·å¼ === */
.ai-section {
    margin-top: 25px;
    padding: 20px;
    background: #f0fdf4; /* æµ…ç»¿è‰²èƒŒæ™¯ï¼Œä»£è¡¨æ™ºæ…§/è¾…åŠ© */
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    display: none; /* é»˜è®¤éšè— */
    animation: fadeIn 0.5s ease;
}

.ai-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    color: #166534;
    margin-bottom: 10px;
    font-size: 16px;
}

.ai-content {
    font-size: 15px;
    color: #374151;
    line-height: 1.8;
}

/* Markdown æ ·å¼å¾®è°ƒ */
.ai-content strong { color: #059669; }
.ai-content ul { padding-left: 20px; }
.ai-content p { margin: 8px 0; }

/* AI æŒ‰é’®åŠ¨ç”» */
.ai-btn-loading {
    cursor: wait;
    opacity: 0.7;
}

/* é—ªçƒå…‰æ ‡æ•ˆæœ */
.typing-cursor::after {
    content: 'â–‹';
    display: inline-block;
    animation: blink 1s infinite;
    color: var(--primary);
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}
/* === æ–°å¢ï¼šç­”é¢˜å¡æ ·å¼ === */
.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
}

.back-btn {
    font-size: 14px;
    color: var(--primary);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    font-weight: bold;
}
.back-btn:hover { text-decoration: underline; }

.question-grid {
    
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    padding-right: 5px;
    
    /* === æ–°å¢/ä¿®æ”¹ä»¥ä¸‹å…³é”®å±æ€§ === */
    flex: 1;            /* è‡ªåŠ¨å æ®å‰©ä½™ç©ºé—´ */
    overflow-y: auto;   /* å†…å®¹è¶…å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
    min-height: 0;      /* ã€å…³é”®ã€‘é˜²æ­¢Flexå­é¡¹æº¢å‡º */
    align-content: start; /* é˜²æ­¢å†…å®¹å°‘æ—¶è¢«æ‹‰ä¼¸ */
    padding-bottom: 40px; /* åº•éƒ¨ç•™ç‚¹ç©ºéš™ï¼Œé˜²æ­¢é®æŒ¡ */
}

.q-circle {
    width: 36px;
    height: 36px;
    border-radius: 8px; /* åœ†è§’çŸ©å½¢ */
    background: #f3f4f6;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.q-circle:hover {
    background: #e5e7eb;
    transform: scale(1.1);
}

/* å½“å‰æ­£åœ¨åšçš„é¢˜ */
.q-circle.active {
    border-color: var(--primary);
    color: var(--primary);
    background: #eff6ff;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

/* åšå¯¹çš„é¢˜ */
.q-circle.correct {
    background: var(--success);
    color: white;
}

/* åšé”™çš„é¢˜ */
.q-circle.wrong {
    background: var(--error);
    color: white;
}
/* æ·»åŠ æˆ–ä¿®æ”¹è¿™ä¸ª ID é€‰æ‹©å™¨ */
#sidebar-content {
    display: flex;
    flex-direction: column;
    height: 100%;       /* å¼ºåˆ¶å æ»¡ä¾§è¾¹æ é«˜åº¦ */
    overflow: hidden;   /* é˜²æ­¢çˆ¶çº§å‡ºç°æ»šåŠ¨æ¡ */
}
    </style>
</head>
<body>
<div id="login-overlay">
    <div class="login-card">
        <div class="login-header">
            <h3>ğŸ”’ é¢˜åº“ç³»ç»Ÿç™»å½•</h3>
            <p>å†…éƒ¨ç³»ç»Ÿ | ä»…é™æˆæƒäººå‘˜è®¿é—®</p>
        </div>
        <div class="input-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å">
        </div>
        <div class="input-group">
            <label>å¯†ç </label>
            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        <button class="login-btn" onclick="handleLogin()">ç«‹å³ç™»å½•</button>
        <p id="login-msg" class="error-msg"></p>
    </div>
</div>


<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div id="sidebar-content"></div>
    </div>

<div class="main-content">
    <div class="container">
        <div class="header-info">
            <span id="current-unit-name">åŠ è½½ä¸­...</span>
            <span id="progress-text">0 / 0</span>
        </div>

        <div id="quiz-area">
            <div class="question-text" id="q-text">
                é¢˜ç›®æ•°æ®åŠ è½½ä¸­...
            </div>
            <ul class="options-list" id="options-list">
                </ul>
            <div class="result-msg" id="result-msg"></div>
            <div id="ai-container" style="text-align: center; margin-top: 15px; display: none;">
    <button class="btn btn-outline" id="ask-ai-btn" onclick="askDeepSeek()" style="border-color: #10b981; color: #10b981;">
        ğŸ¤£ AI æ·±åº¦è§£æ
    </button>
</div>

<div class="ai-section" id="ai-response-box">
    <div class="ai-header">
        <span>ğŸ¤£æ™ºèƒ½åŠ©æ•™</span>
    </div>
    <div class="ai-content" id="ai-content"></div>
        </div>

            <div class="control-bar">
            <button class="btn btn-outline" onclick="prevQuestion()">â¬… ä¸Šä¸€é¢˜</button>
            
            <div class="toggle-mode">
                <label class="switch">
                    <input type="checkbox" id="wrong-mode-toggle" onchange="toggleWrongMode()">
                    <span class="slider"></span>
                </label>
                <span>åªçœ‹é”™é¢˜</span>
            </div>

            <button class="btn btn-primary" onclick="submitOrNext()" id="action-btn">æäº¤ç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<script src="quiz_data.js"></script>

<script>
    // çŠ¶æ€ç®¡ç†
    let currentUnitKey = "";
    let questions = []; 
    let wrongBook = JSON.parse(localStorage.getItem('wrongBook') || '[]');
    let currentIndex = 0;
    let isWrongMode = false;
    let hasSubmitted = false;
    let selectedOptions = new Set(); 
// === æ–°å¢ï¼šç”¨æˆ·åå•é…ç½® (åœ¨è¿™é‡Œé™å®šåé¢) ===
const ALLOWED_USERS = [
    { u: "æèˆª", p: "2401100119" },   // ç®¡ç†å‘˜
    { u: "æå®›æ¡", p: "2401100209" },  // ç”¨æˆ·1
    { u: "å§œæµ©å®‡", p: "2401100217" },  // ç”¨æˆ·2
    { u: "æ±ªç¾æ±", p: "2405180131" },     // ç”¨æˆ·3
    { u: "å¾çˆ½", p: "2401100106" },      // ç”¨æˆ·4
    { u: "å§œé›¨æ± ", p: "2401100130" },  // ç”¨æˆ·5
    { u: "å­Ÿç¥¥ç‘", p: "2405180231" },    // ç”¨æˆ·6
    { u: "åˆ˜å»ºå­œ", p: "2401100107" },   // ç”¨æˆ·7
];

// æ£€æŸ¥æ˜¯å¦å·²ç™»å½• (åˆ·æ–°é¡µé¢å…ç™»å½•)
const isLogged = sessionStorage.getItem("is_logged");
if (isLogged) {
    document.getElementById("login-overlay").style.display = "none";
} else {
    document.body.classList.add("locked");
}

function handleLogin() {
    const uInput = document.getElementById("username").value.trim();
    const pInput = document.getElementById("password").value.trim();
    const msg = document.getElementById("login-msg");

    if (!uInput || !pInput) {
        msg.innerText = "âš ï¸ è´¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©º";
        return;
    }

    // éªŒè¯è´¦å·å¯†ç 
    const user = ALLOWED_USERS.find(item => item.u === uInput && item.p === pInput);

    if (user) {
        msg.innerText = "";
        // ç™»å½•æˆåŠŸåŠ¨ç”»
        const overlay = document.getElementById("login-overlay");
        overlay.style.opacity = "0";
        overlay.style.transition = "opacity 0.5s";
        
        setTimeout(() => {
            overlay.style.display = "none";
            document.body.classList.remove("locked");
            // ä¿å­˜ç™»å½•çŠ¶æ€ (å…³é—­æµè§ˆå™¨åå¤±æ•ˆ)
            sessionStorage.setItem("is_logged", "true");
            // å¯é€‰ï¼šæ˜¾ç¤ºæ¬¢è¿è¯­
            alert(`æ¬¢è¿å›æ¥ï¼Œ${uInput}ï¼`);
        }, 500);
    } else {
        msg.innerText = "âŒ è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œæ— è®¿é—®æƒé™";
        // ç®€å•çš„é”™è¯¯æŠ–åŠ¨åŠ¨ç”»
        const card = document.querySelector('.login-card');
        card.style.transform = "translateX(10px)";
        setTimeout(() => card.style.transform = "translateX(0)", 100);
        setTimeout(() => card.style.transform = "translateX(-10px)", 200);
        setTimeout(() => card.style.transform = "translateX(0)", 300);
    }
}

// æ”¯æŒå›è½¦ç™»å½•
document.getElementById("password").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        handleLogin();
    }
});
    // åˆå§‹åŒ–
    window.onload = function() {
        if (typeof QUIZ_DATA === 'undefined') {
            alert("æœªæ£€æµ‹åˆ°æ•°æ®æ–‡ä»¶ï¼è¯·å…ˆè¿è¡ŒPythonè„šæœ¬ç”Ÿæˆ quiz_data.js");
            return;
        }
        initSidebar();
    };

    // 1. åˆå§‹åŒ–ä¾§è¾¹æ 
    function initSidebar() {
        const sidebar = document.getElementById('sidebar');
        // æ¸…ç©ºé™¤äº†æ ‡é¢˜ä»¥å¤–çš„å†…å®¹ (å¦‚æœæœ‰çš„è¯)
        const title = sidebar.querySelector('h2');
        sidebar.innerHTML = ''; 
        sidebar.appendChild(title);

        const keys = Object.keys(QUIZ_DATA);
        
        keys.forEach((key, index) => {
            const btn = document.createElement('button');
            btn.className = 'unit-btn';
            btn.innerText = key + ` (${QUIZ_DATA[key].length})`;
            btn.onclick = () => loadUnit(key);
            sidebar.appendChild(btn);
            
            if(index === 0) loadUnit(key);
        });
    }

    // 2. åŠ è½½å•å…ƒ
    function loadUnit(key) {
        currentUnitKey = key;
        
        // æ›´æ–°ä¾§è¾¹æ æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.unit-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.includes(key));
        });

        // é”™é¢˜æ¨¡å¼è¿‡æ»¤
        if (isWrongMode) {
            const allQ = QUIZ_DATA[key];
            questions = allQ.filter(q => wrongBook.includes(q.id));
            if(questions.length === 0) {
                alert("å¤ªæ£’äº†ï¼æœ¬å•å…ƒæ²¡æœ‰é”™é¢˜ã€‚\nå³å°†è‡ªåŠ¨åˆ‡æ¢å›å…¨é¢˜æ¨¡å¼ã€‚");
                document.getElementById('wrong-mode-toggle').checked = false;
                isWrongMode = false;
                questions = allQ;
            }
        } else {
            questions = QUIZ_DATA[key];
        }

        currentIndex = 0;
        document.getElementById('current-unit-name').innerText = key + (isWrongMode ? " (é”™é¢˜æœ¬)" : "");
        renderQuestion();
    }

    // 3. æ¸²æŸ“é¢˜ç›®
    function renderQuestion() {
        hasSubmitted = false;
        selectedOptions.clear();
        const q = questions[currentIndex];
        
        // è¿›åº¦
        document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${questions.length}`;
        
        // é¢˜ç›®
        const qText = document.getElementById('q-text');
        qText.innerHTML = `<span class="q-type">${q.type}</span> ${q.question}`;
        
        // é€‰é¡¹
        const list = document.getElementById('options-list');
        list.innerHTML = '';
        document.getElementById('result-msg').innerText = '';
        document.getElementById('action-btn').innerText = 'æäº¤ç­”æ¡ˆ';
        document.getElementById('action-btn').classList.remove('btn-outline');
        document.getElementById('action-btn').classList.add('btn-primary');

        q.options.forEach(optStr => {
            const li = document.createElement('li');
            li.className = 'option-item';
            li.innerText = optStr;
            const optChar = optStr.charAt(0);
            li.onclick = () => handleSelect(li, optChar, q.type);
            list.appendChild(li);
        });
    }

    // 4. å¤„ç†é€‰æ‹©
    function handleSelect(el, char, type) {
        if (hasSubmitted) return; 

        if (type === 'å¤šé€‰é¢˜') {
            if (selectedOptions.has(char)) {
                selectedOptions.delete(char);
                el.classList.remove('selected');
            } else {
                selectedOptions.add(char);
                el.classList.add('selected');
            }
        } else {
            selectedOptions.clear();
            selectedOptions.add(char);
            document.querySelectorAll('.option-item').forEach(li => li.classList.remove('selected'));
            el.classList.add('selected');
        }
    }

    // 5. æäº¤/ä¸‹ä¸€é¢˜
    function submitOrNext() {
        const btn = document.getElementById('action-btn');
        const q = questions[currentIndex];

        if (!hasSubmitted) {
            // === æäº¤é€»è¾‘ ===
            if (selectedOptions.size === 0) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ ğŸ¤”");

            const myAns = Array.from(selectedOptions).sort().join('');
            const correctAns = q.answer;
            
            // æ ·å¼åé¦ˆ
            const items = document.querySelectorAll('.option-item');
            items.forEach(item => {
                const char = item.innerText.charAt(0);
                // æ ‡è®°æ­£ç¡®ç­”æ¡ˆ
                if (correctAns.includes(char)) item.classList.add('correct'); 
                // æ ‡è®°ç”¨æˆ·é€‰é”™çš„ç­”æ¡ˆ
                if (selectedOptions.has(char) && !correctAns.includes(char)) item.classList.add('wrong'); 
            });

            const msg = document.getElementById('result-msg');
            if (myAns === correctAns) {
                msg.innerHTML = '<span style="color:var(--success)">ğŸ‰ å›ç­”æ­£ç¡®ï¼ç»§ç»­ä¿æŒ</span>';
                if (isWrongMode) {
                    removeFromWrongBook(q.id);
                }
            } else {
                msg.innerHTML = `<span style="color:var(--error)">ğŸ˜… å›ç­”é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${correctAns}</span>`;
                addToWrongBook(q.id);
            }

            hasSubmitted = true;
            btn.innerText = (currentIndex === questions.length - 1) ? 'å®Œæˆç»ƒä¹ ' : 'ä¸‹ä¸€é¢˜ â¡';
            // æäº¤åæŒ‰é’®å˜è‰²ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»ç»§ç»­
            
        } else {
            // === ä¸‹ä¸€é¢˜é€»è¾‘ ===
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                renderQuestion();
            } else {
                alert("æ­å–œï¼æœ¬å•å…ƒç»ƒä¹ å·²ç»“æŸã€‚");
            }
        }
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
        } else {
            alert("å·²ç»æ˜¯ç¬¬ä¸€é¢˜äº†");
        }
    }

    // 6. é”™é¢˜æœ¬é€»è¾‘
    function addToWrongBook(id) {
        if (!wrongBook.includes(id)) {
            wrongBook.push(id);
            localStorage.setItem('wrongBook', JSON.stringify(wrongBook));
        }
    }
    
    function removeFromWrongBook(id) {
        wrongBook = wrongBook.filter(wid => wid !== id);
        localStorage.setItem('wrongBook', JSON.stringify(wrongBook));
    }

    function toggleWrongMode() {
        isWrongMode = document.getElementById('wrong-mode-toggle').checked;
        loadUnit(currentUnitKey);
    }

    
    // === ä¾§è¾¹æ åˆ‡æ¢å‡½æ•° ===
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

const DEEP_SEEK_API_KEY = "sk-13bfc692c270453c823064d88dfa7860";

async function askDeepSeek() {
    const q = questions[currentIndex];
    const btn = document.getElementById('ask-ai-btn');
    const contentBox = document.getElementById('ai-content');
    const responseBox = document.getElementById('ai-response-box');

    // 1. å‡†å¤‡ UI
    btn.disabled = true;
    btn.innerHTML = 'âš¡ æ­£åœ¨æ€è€ƒä¸­...';
    btn.classList.add('ai-btn-loading');
    responseBox.style.display = 'block';
    contentBox.innerHTML = '<span class="typing-cursor">æ­£åœ¨åˆ†æé¢˜ç›®è€ƒç‚¹...</span>';

    // 2. æ„é€  Prompt (æç¤ºè¯)
    const prompt = `
    ä½ æ˜¯ä¸€ä½é©¬å…‹æ€ä¸»ä¹‰åŸç†è¯¾ç¨‹çš„èµ„æ·±æ•™å¸ˆã€‚è¯·è§£æè¿™é“é¢˜ï¼š
    ã€é¢˜ç›®ã€‘${q.question}
    ã€é€‰é¡¹ã€‘${q.options.join('; ')}
    ã€æ­£ç¡®ç­”æ¡ˆã€‘${q.answer}
    
    è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
    1. **è§£æ**ï¼šç®€è¦åˆ†æä¸ºä½•é€‰è¿™ä¸ªç­”æ¡ˆã€‚
    2. **çŸ¥è¯†ç‚¹**ï¼šé¢˜ç›®æ¶‰åŠçš„é©¬åŸæ ¸å¿ƒæ¦‚å¿µã€‚
    3. **æ˜“é”™ç‚¹**ï¼šå¦‚æœé€‚ç”¨ï¼ŒæŒ‡å‡ºä¸ºä»€ä¹ˆå…¶ä»–é€‰é¡¹æ˜¯é”™çš„ã€‚
    4.**æ‹“å±•**: æä¾›ä¸€ä¸ªç±»ä¼¼çš„é¢˜ç›®ï¼Œå¹¶ç»™å‡ºç­”æ¡ˆ
    `;

    try {
        // 3. å‘èµ·è¯·æ±‚
        const response = await fetch('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${DEEP_SEEK_API_KEY}`
            },
            body: JSON.stringify({
                model: "deepseek-chat", // æˆ–è€… deepseek-v3
                messages: [
                    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„é©¬å…‹æ€ä¸»ä¹‰åŸç†è¾…å¯¼è€å¸ˆï¼Œè¯­è¨€é€šä¿—æ˜“æ‡‚ã€‚"},
                    {"role": "user", "content": prompt}
                ],
                stream: false // ç®€å•èµ·è§ï¼Œè¿™é‡Œæš‚ä¸ä½¿ç”¨æµå¼ä¼ è¾“ï¼Œå¦‚æœéœ€è¦æ‰“å­—æœºæ•ˆæœå¯ä»¥æ”¹ä¸º true å¹¶å¤„ç†æµ
            })
        });

        if (!response.ok) {
            throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        const aiText = data.choices[0].message.content;

        // 4. æ¸²æŸ“ Markdown
        contentBox.innerHTML = marked.parse(aiText);

    } catch (error) {
        console.error(error);
        contentBox.innerHTML = `<span style="color:red">ğŸ˜¢ è§£æå¤±è´¥ï¼šè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œè¿æ¥ã€‚<br>é”™è¯¯ä¿¡æ¯ï¼š${error.message}</span>`;
    } finally {
        // 5. æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = 'ğŸ¤– é‡æ–°è§£æ';
        btn.disabled = false;
        btn.classList.remove('ai-btn-loading');
    }
}


const originalSubmitOrNext = submitOrNext;
submitOrNext = function() {
    const isSubmitAction = !hasSubmitted;
    
    // è°ƒç”¨åŸé€»è¾‘
    originalSubmitOrNext();

    // è¡¥ä¸é€»è¾‘
    if (isSubmitAction && hasSubmitted) {
        // åˆšåˆšæäº¤äº†ç­”æ¡ˆ -> æ˜¾ç¤º AI æŒ‰é’®
        document.getElementById('ai-container').style.display = 'block';
        // å¦‚æœæƒ³è‡ªåŠ¨è§¦å‘ï¼Œå¯ä»¥åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨ askDeepSeek(); 
        // ä½†å»ºè®®æ‰‹åŠ¨ç‚¹å‡»ï¼Œçœé’±çœ Token
    } else if (!isSubmitAction && currentIndex < questions.length) {
        // ç‚¹å‡»äº†ä¸‹ä¸€é¢˜ -> éšè— AI åŒºåŸŸ
        document.getElementById('ai-container').style.display = 'none';
        document.getElementById('ai-response-box').style.display = 'none';
        document.getElementById('ai-content').innerHTML = '';
    }
};
// === ç­”é¢˜å¡ä¸ä¾§è¾¹æ é€»è¾‘æ›´æ–° ===

// 1. æ¸²æŸ“ä¾§è¾¹æ ï¼šç« èŠ‚åˆ—è¡¨æ¨¡å¼
function renderUnitList() {
    const container = document.getElementById('sidebar-content');
    container.innerHTML = `
        <h2>ğŸ“š é¢˜åº“é€‰æ‹©</h2>
        <div id="unit-list-area"></div>
    `;
    
    const listArea = document.getElementById('unit-list-area');
    const keys = Object.keys(QUIZ_DATA);
    
    keys.forEach((key) => {
        const btn = document.createElement('button');
        btn.className = 'unit-btn';
        btn.innerText = `${key} (${QUIZ_DATA[key].length}é¢˜)`;
        btn.onclick = () => loadUnit(key);
        listArea.appendChild(btn);
    });
}

// 2. æ¸²æŸ“ä¾§è¾¹æ ï¼šç­”é¢˜å¡æ¨¡å¼
function renderQuestionGrid() {
    const container = document.getElementById('sidebar-content');
    // æ·»åŠ "è¿”å›ç›®å½•"æŒ‰é’®å’Œç½‘æ ¼å®¹å™¨
    container.innerHTML = `
        <div class="sidebar-header">
            <span style="font-weight:bold; font-size:16px;">ç­”é¢˜å¡</span>
            <button class="back-btn" onclick="renderUnitList()">â¬… è¿”å›ç›®å½•</button>
        </div>
        <div class="question-grid" id="q-grid"></div>
    `;

    const grid = document.getElementById('q-grid');
    
    questions.forEach((q, index) => {
        const btn = document.createElement('div');
        btn.className = 'q-circle';
        btn.innerText = index + 1;
        btn.id = `q-btn-${index}`; // ç»™æ¯ä¸ªæŒ‰é’®ä¸€ä¸ªIDæ–¹ä¾¿åç»­æ›´æ–°
        
        // æ¢å¤ä¹‹å‰çš„çŠ¶æ€é¢œè‰²
        if (q.userStatus === 'correct') btn.classList.add('correct');
        if (q.userStatus === 'wrong') btn.classList.add('wrong');
        
        // å½“å‰é¢˜ç›®é«˜äº®
        if (index === currentIndex) btn.classList.add('active');

        // ç‚¹å‡»è·³è½¬
        btn.onclick = () => {
            currentIndex = index;
            renderQuestion();
            // æ‰‹æœºç«¯ç‚¹å‡»åè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
            if(window.innerWidth <= 768) toggleSidebar();
        };
        
        grid.appendChild(btn);
    });
}

// 3. ä¿®æ”¹ loadUnitï¼šåŠ è½½ç« èŠ‚æ—¶ï¼Œåˆ‡æ¢åˆ°ç­”é¢˜å¡è§†å›¾
const originalLoadUnit = loadUnit; // ä¿å­˜æ—§å¼•ç”¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ä½†ä¸é‡è¦ï¼Œç›´æ¥é‡å†™æœ€å¥½
loadUnit = function(key) {
    currentUnitKey = key;
    
    // å¤„ç†é”™é¢˜æ¨¡å¼
    if (isWrongMode) {
        const allQ = QUIZ_DATA[key];
        // ç­›é€‰é”™é¢˜ï¼Œä½†è¦ä¿ç•™åŸé¢˜ç›®åœ¨ allQ ä¸­çš„ç´¢å¼•æˆ–IDä»¥ä¾¿å¤„ç†ï¼Ÿ
        // ç®€å•å¤„ç†ï¼šé”™é¢˜æ¨¡å¼ä¸‹é€šå¸¸ä¸ä½¿ç”¨å…¨é‡ç­”é¢˜å¡ï¼Œæˆ–è€…ç­”é¢˜å¡åªæ˜¾ç¤ºé”™é¢˜
        questions = allQ.filter(q => wrongBook.includes(q.id));
        if(questions.length === 0) {
            alert("æœ¬å•å…ƒæ²¡æœ‰é”™é¢˜ï¼Œè‡ªåŠ¨åˆ‡å›å…¨é¢˜æ¨¡å¼");
            document.getElementById('wrong-mode-toggle').checked = false;
            isWrongMode = false;
            questions = QUIZ_DATA[key];
        }
    } else {
        questions = QUIZ_DATA[key];
        // åˆå§‹åŒ–çŠ¶æ€å­—æ®µï¼ˆé˜²æ­¢åˆ‡æ¢ç« èŠ‚åçŠ¶æ€æ··ä¹±ï¼‰
        // æ³¨æ„ï¼šå¦‚æœä½ æƒ³ä¿ç•™åšé¢˜è®°å½•ï¼Œè¿™é‡Œä¸è¦é‡ç½®ã€‚
        // ä½†ä¸ºäº†ç®€å•ï¼Œæ¯æ¬¡é‡æ–°è¿›å•å…ƒéƒ½é‡ç½®è§†è§‰çŠ¶æ€ï¼ˆé™¤éä½ æœ‰æ•°æ®åº“ï¼‰
        // questions.forEach(q => q.userStatus = null); 
    }

    currentIndex = 0;
    document.getElementById('current-unit-name').innerText = key + (isWrongMode ? " (é”™é¢˜æœ¬)" : "");
    
    // æ¸²æŸ“é¢˜ç›®
    renderQuestion();
    
    // === å…³é”®å˜åŒ–ï¼šæ¸²æŸ“ç­”é¢˜å¡ ===
    renderQuestionGrid();
};

// 4. ä¿®æ”¹ renderQuestionï¼šæ›´æ–°ç­”é¢˜å¡ä¸Šçš„â€œå½“å‰é¢˜â€é«˜äº®
const originalRenderQuestion = renderQuestion; // å¦‚æœæœ‰çš„è¯
renderQuestion = function() {
    // æ‰§è¡ŒåŸæœ‰çš„æ¸²æŸ“é€»è¾‘ï¼ˆæŠŠåŸæ¥çš„ä»£ç é€»è¾‘æ¬è¿‡æ¥ï¼Œæˆ–è€…ç›´æ¥è¦†ç›–ï¼‰
    // ä¸ºäº†ç¨³å¦¥ï¼Œè¿™é‡Œå®Œæ•´é‡å†™ renderQuestion é€»è¾‘ï¼ŒåŒ…å«ç­”é¢˜å¡æ›´æ–°
    
    hasSubmitted = false;
    selectedOptions.clear();
    const q = questions[currentIndex];
    
    document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${questions.length}`;
    
    const qText = document.getElementById('q-text');
    qText.innerHTML = `<span class="q-type">${q.type}</span> ${q.question}`;
    
    const list = document.getElementById('options-list');
    list.innerHTML = '';
    document.getElementById('result-msg').innerText = '';
    
    // é‡ç½®æŒ‰é’®
    const actionBtn = document.getElementById('action-btn');
    actionBtn.innerText = 'æäº¤ç­”æ¡ˆ';
    actionBtn.classList.remove('btn-outline');
    actionBtn.classList.add('btn-primary');
    
    // éšè— AI åŒºåŸŸ
    document.getElementById('ai-container').style.display = 'none';
    document.getElementById('ai-response-box').style.display = 'none';

    q.options.forEach(optStr => {
        const li = document.createElement('li');
        li.className = 'option-item';
        li.innerText = optStr;
        const optChar = optStr.charAt(0);
        li.onclick = () => handleSelect(li, optChar, q.type);
        list.appendChild(li);
    });

    // === æ›´æ–°ç­”é¢˜å¡é«˜äº® ===
    // ç§»é™¤æ‰€æœ‰ active
    document.querySelectorAll('.q-circle').forEach(b => b.classList.remove('active'));
    // ç»™å½“å‰é¢˜æ·»åŠ  active
    const currentBtn = document.getElementById(`q-btn-${currentIndex}`);
    if (currentBtn) {
        currentBtn.classList.add('active');
        // è‡ªåŠ¨æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
        currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
};

// 5. ä¿®æ”¹ submitOrNextï¼šæäº¤æ—¶æ›´æ–°ç­”é¢˜å¡é¢œè‰²ï¼ˆçº¢/ç»¿ï¼‰
// è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠä¹‹å‰çš„ AI é€»è¾‘å’Œç­”é¢˜å¡é€»è¾‘æ•´åˆåœ¨ä¸€èµ·
submitOrNext = function() {
    const btn = document.getElementById('action-btn');
    const q = questions[currentIndex];

    // å¦‚æœæ˜¯â€œæäº¤â€åŠ¨ä½œ
    if (!hasSubmitted) {
        if (selectedOptions.size === 0) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ ğŸ¤”");

        const myAns = Array.from(selectedOptions).sort().join('');
        const correctAns = q.answer;
        
        // æ ·å¼åé¦ˆ
        const items = document.querySelectorAll('.option-item');
        items.forEach(item => {
            const char = item.innerText.charAt(0);
            if (correctAns.includes(char)) item.classList.add('correct'); 
            if (selectedOptions.has(char) && !correctAns.includes(char)) item.classList.add('wrong'); 
        });

        const msg = document.getElementById('result-msg');
        
        // === ç­”é¢˜å¡çŠ¶æ€æ›´æ–° ===
        const gridBtn = document.getElementById(`q-btn-${currentIndex}`);
        
        if (myAns === correctAns) {
            msg.innerHTML = '<span style="color:var(--success)">ğŸ‰ å›ç­”æ­£ç¡®ï¼</span>';
            if (isWrongMode) removeFromWrongBook(q.id);
            
            // è®°å½•çŠ¶æ€å¹¶å˜ç»¿
            q.userStatus = 'correct'; 
            if(gridBtn) gridBtn.classList.add('correct');
        } else {
            msg.innerHTML = `<span style="color:var(--error)">ğŸ˜… ç­”æ¡ˆæ˜¯ï¼š${correctAns}</span>`;
            addToWrongBook(q.id);
            
            // è®°å½•çŠ¶æ€å¹¶å˜çº¢
            q.userStatus = 'wrong';
            if(gridBtn) gridBtn.classList.add('wrong');
        }

        hasSubmitted = true;
        btn.innerText = (currentIndex === questions.length - 1) ? 'å®Œæˆç»ƒä¹ ' : 'ä¸‹ä¸€é¢˜ â¡';
        
        // æ˜¾ç¤º AI æŒ‰é’®
        document.getElementById('ai-container').style.display = 'block';

    } else {
        // å¦‚æœæ˜¯â€œä¸‹ä¸€é¢˜â€åŠ¨ä½œ
        if (currentIndex < questions.length - 1) {
            currentIndex++;
            renderQuestion();
        } else {
            alert("æœ¬å•å…ƒç»ƒä¹ ç»“æŸï¼");
            renderUnitList(); // ç»“æŸåè¿”å›ç›®å½•
        }
    }
};

// é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨åˆ—è¡¨æ¸²æŸ“
// è¦†ç›–åŸæœ¬çš„ window.onload
window.onload = function() {
    if (typeof QUIZ_DATA === 'undefined') {
        alert("æœªæ£€æµ‹åˆ°æ•°æ®æ–‡ä»¶ï¼");
        return;
    }
    renderUnitList(); // åˆå§‹æ˜¾ç¤ºç›®å½•
};
</script>
</body>
</html>
